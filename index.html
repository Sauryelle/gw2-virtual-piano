<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarya's Music Thingy</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="saryamusic2.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --gw2-red-dark: #3a0e0e;
            --gw2-red: #6a1f1f;
            --gw2-gold: #d4af37;
            --gw2-gold-dark: #8c7355;
            --gw2-bg: #1a1818;
            --gw2-parchment: #e6d8c3;
        }

        body {
            background-color: var(--gw2-bg);
            background-image:
                radial-gradient(circle at 50% 50%, #3a2e2a 0%, #1a1818 100%),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" opacity="0.03"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4"/></filter><rect width="200" height="200" filter="url(%23n)"/></svg>');
            font-family: 'Cormorant Garamond', serif;
            color: var(--gw2-parchment);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            user-select: none;
            padding: 2rem 1rem;
            box-sizing: border-box;
        }

        .gw2-panel {
            background: linear-gradient(135deg, #2c2420, #181514);
            border: 2px solid #5a4b3c;
            box-shadow: 0 0 30px rgba(0,0,0,0.9), inset 0 0 20px rgba(0,0,0,0.8);
            position: relative;
        }

        .gw2-panel::before {
            content: '';
            position: absolute;
            top: 6px; left: 6px; right: 6px; bottom: 6px;
            border: 1px solid var(--gw2-gold-dark);
            pointer-events: none;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .gw2-title {
            font-family: 'Cinzel', serif;
            color: var(--gw2-gold);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9), 0 0 15px rgba(212,175,55,0.4);
            letter-spacing: 3px;
        }

        .gw2-button {
            background: linear-gradient(to bottom, var(--gw2-red), var(--gw2-red-dark));
            border: 1px solid #a83a3a;
            color: var(--gw2-parchment);
            font-family: 'Cinzel', serif;
            box-shadow: 0 3px 6px rgba(0,0,0,0.6), inset 0 1px 1px rgba(255,255,255,0.2);
            transition: all 0.15s ease;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .gw2-button:hover {
            background: linear-gradient(to bottom, #8a2a2a, #4a1515);
            border-color: var(--gw2-gold-dark);
            transform: translateY(-1px);
        }

        .gw2-button:active, .gw2-button.active {
            transform: translateY(2px) scale(0.98);
            background: linear-gradient(to bottom, #fff3e0, #ffb347);
            color: #5a1e00;
            border-color: var(--gw2-gold);
            box-shadow: inset -1px -1px 3px rgba(255,255,255,0.5),
                        inset 2px 4px 8px rgba(0,0,0,0.3),
                        0 0 15px #ff8c00;
        }

        .gw2-select {
            background: linear-gradient(to bottom, #2c2420, #181514);
            border: 1px solid #5a4b3c;
            color: var(--gw2-gold);
            font-family: 'Cinzel', serif;
            max-width: 280px;
            text-overflow: ellipsis;
        }

        .gw2-select option, .gw2-select optgroup {
            background: #181514;
            color: var(--gw2-parchment);
            font-family: 'Cormorant Garamond', serif;
        }

        /* --- GW2 PIANO STYLES --- */
        .piano-container {
            display: flex;
            gap: 4px;
            padding: 10px;
            background: #0a0808;
            border: 2px solid #3a2e2a;
            border-radius: 4px;
            box-shadow: inset 0 5px 15px rgba(0,0,0,0.9);
        }

        .piano-key {
            width: 70px;
            height: 240px;
            background: linear-gradient(to bottom, #d9d0c1, #a39581);
            border: 1px solid #4a3e31;
            border-radius: 2px 2px 8px 8px;
            box-shadow: inset -2px -2px 5px rgba(255,255,255,0.3),
                        inset 2px 2px 5px rgba(0,0,0,0.1),
                        3px 5px 10px rgba(0,0,0,0.7);
            position: relative;
            cursor: pointer;
            transition: transform 0.05s, box-shadow 0.05s;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 20px;
        }

        @media (max-width: 640px) {
            .piano-key { width: 40px; height: 180px; }
            .key-note { font-size: 1rem !important; }
            .key-bind { font-size: 0.7rem !important; }
            .black-key { width: 26px; height: 110px; }
            .black-key .key-note { font-size: 0.8rem !important; }
            .black-key .key-bind { font-size: 0.55rem !important; padding: 0 2px; }
        }

        .piano-key::before {
            content: '';
            position: absolute;
            top: 0; left: 10%; right: 10%; height: 60%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.2), transparent);
            border-radius: 2px;
            pointer-events: none;
        }

        .piano-key.active {
            transform: translateY(4px) scale(0.98);
            background: linear-gradient(to bottom, #fff3e0, #ffb347);
            box-shadow: inset -1px -1px 3px rgba(255,255,255,0.5),
                        inset 2px 4px 8px rgba(0,0,0,0.3),
                        0 0 20px #ff8c00;
            border-color: var(--gw2-gold);
        }

        .black-key {
            width: 44px;
            height: 140px;
            background: linear-gradient(to bottom, #2a2420, #0a0808);
            border-color: #1a1512;
            right: -2px;
            transform: translateX(50%);
        }

        .black-key::before {
            background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent);
        }

        .black-key.active {
            transform: translateX(50%) translateY(4px) scale(0.98);
            background: linear-gradient(to bottom, #5a1515, #8a2a2a);
            box-shadow: inset -1px -1px 3px rgba(255,255,255,0.2),
                        inset 2px 4px 8px rgba(0,0,0,0.6),
                        0 0 15px #ff0000;
            border-color: var(--gw2-red);
        }

        .key-note {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: #2c2420;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.4);
        }

        .key-bind {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 600;
            font-size: 1rem;
            color: #5a4b3c;
            margin-top: 5px;
        }

        .piano-key.active .key-note, .piano-key.active .key-bind {
            color: #5a1e00;
        }

        .piano-key.black-key.active .key-note, .piano-key.black-key.active .key-bind {
            color: #ffe0b2;
        }

        .black-key .key-note {
            color: #d4af37;
            text-shadow: 1px 1px 2px black;
            font-size: 1.2rem;
        }

        .black-key .key-bind {
            color: #a39581;
        }

        /* --- HEARTOPIA PIANO STYLES --- */
        #htp-view {
            background: linear-gradient(to bottom, #221c18, #110e0c);
        }

        .htp-white {
            width: 46px;
            height: 60px;
            background: #fdfdfd;
            border-radius: 12px;
            box-shadow: 0 4px 0 #b0b0b0, 0 5px 8px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 6px;
            position: relative;
            cursor: pointer;
            font-family: sans-serif;
            transition: all 0.05s;
        }

        .htp-white:active, .htp-white.active {
            transform: translateY(4px);
            box-shadow: 0 0px 0 #b0b0b0, 0 2px 3px rgba(0,0,0,0.3);
            background: #e8f0fe;
        }

        .htp-white-num {
            font-weight: bold; font-size: 1.15rem; color: #222; line-height: 1;
        }

        .htp-white-sol {
            font-size: 0.55rem; color: #666; font-weight: bold; letter-spacing: 0.5px; margin-top: 2px;
        }

        .htp-bind-tag {
            position: absolute; bottom: -12px;
            background: #8e8e8e; color: white; padding: 2px 6px; border-radius: 6px;
            font-size: 0.65rem; box-shadow: 0 2px 0 #555; font-weight: bold;
            transition: all 0.05s;
        }

        .htp-white:active .htp-bind-tag, .htp-white.active .htp-bind-tag {
            box-shadow: 0 0px 0 #555; transform: translateY(2px);
        }

        .htp-black {
            width: 32px; height: 32px;
            background: #333; border-radius: 50%;
            box-shadow: 0 3px 0 #111, 0 4px 6px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            color: #eee; font-size: 0.75rem; font-weight: bold; font-family: sans-serif;
            position: absolute; top: -14px; right: -20px; z-index: 10; cursor: pointer;
            transition: all 0.05s;
        }

        .htp-black:active, .htp-black.active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #111, 0 2px 3px rgba(0,0,0,0.5);
            background: #555;
        }

        .status-text {
            color: #a39581;
            font-style: italic;
            text-shadow: 1px 1px 2px black;
        }
    </style>
</head>
<body>

    <div class="flex flex-col xl:flex-row w-full max-w-[1800px] mx-auto gap-6 items-stretch justify-center">
        <!-- Main App Panel -->
        <div class="gw2-panel p-6 sm:p-10 rounded-xl flex flex-col items-center flex-1 w-full max-w-[1000px]">

            <!-- Header -->
            <div class="text-center mb-6">
                <!-- Logo Integration -->
                <img src="saryamusic2.png" alt="Sarya's Music Thingy" class="mx-auto h-48 sm:h-64 mb-4 object-contain drop-shadow-[0_10px_20px_rgba(0,0,0,0.8)]" onerror="this.style.display='none'">

                <h1 class="gw2-title text-4xl sm:text-5xl mb-2">Sarya's Music Thingy</h1>
                <p class="status-text text-lg mb-5">For exclusive use of everyone.</p>

                <button id="btn-toggle-songbook" class="gw2-button px-6 py-2 rounded font-bold text-sm tracking-widest text-center shadow-lg border border-[#8c7355] text-[#e6d8c3]">
                    Open Songbook
                </button>
            </div>

            <!-- Global Advanced Controls -->
            <div class="flex flex-col w-full max-w-4xl mb-6 gap-4 px-2 mt-2">
                <!-- SF2 Loading -->
                <div class="flex justify-center w-full gap-4 items-center">
                    <label for="sf2-upload" class="gw2-button px-4 py-1.5 rounded font-bold text-sm tracking-widest cursor-pointer text-center whitespace-nowrap">
                        Load SF2
                    </label>
                    <input type="file" id="sf2-upload" accept=".sf2" class="hidden">
                    <button id="btn-unload-sf2" class="gw2-button px-4 py-1.5 rounded font-bold text-sm tracking-widest text-center hidden whitespace-nowrap">
                        Unload SF2
                    </button>
                </div>

                <!-- Instrument Row -->
                <div class="flex justify-center w-full gap-2 items-center">
                    <select id="synth-select" class="gw2-select w-full max-w-xs px-4 py-2 rounded font-bold text-sm tracking-widest cursor-pointer text-center outline-none focus:border-[#d4af37]">
                        <optgroup label="Default Magic Instruments">
                            <option value="lute">Instrument: Lute</option>
                            <option value="brass">Instrument: Brass</option>
                            <option value="flute">Instrument: Flute</option>
                            <option value="crystal">Instrument: Crystal</option>
                        </optgroup>
                        <!-- Dynamic SF2 group appended here via JS -->
                    </select>
                </div>
            </div>

            <div id="sys-message" class="text-[#d4af37] font-['Cinzel'] h-6 mb-4 opacity-0 transition-opacity duration-500 text-sm tracking-wider">
                Instrument Attuned.
            </div>

            <!-- ============================== -->
            <!-- VIEW 1: GW2 PIANO (1 Octave)   -->
            <!-- ============================== -->
            <div id="gw2-view" class="flex flex-col items-center w-full">

                <!-- Octave Row (GW2 Only) -->
                <div class="flex flex-col sm:flex-row justify-center w-full gap-2 items-center mb-4">
                    <button id="btn-oct-down" class="gw2-button w-full sm:w-auto px-4 py-2 rounded font-bold text-sm tracking-widest text-center">
                        [ Q ] Octave -
                    </button>

                    <div class="bg-black/50 border border-[#5a4b3c] px-4 py-2 rounded text-center w-full sm:w-auto min-w-[140px]">
                        <span class="text-[#d4af37] font-['Cinzel'] font-bold text-lg" id="octave-display">Octave: Mid</span>
                    </div>

                    <button id="btn-oct-up" class="gw2-button w-full sm:w-auto px-4 py-2 rounded font-bold text-sm tracking-widest text-center">
                        [ E ] Octave +
                    </button>
                </div>

                <div class="flex flex-col sm:flex-row justify-center items-center w-full mb-6 gap-4 sm:gap-8">
                    <label class="flex items-center gap-2 cursor-pointer status-text hover:text-[#d4af37] transition-colors">
                        <input type="checkbox" id="octave-toggle" class="w-4 h-4 accent-[#6a1f1f] cursor-pointer" checked>
                        <span>Restrict Octaves (Low / Mid / High)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer status-text hover:text-[#d4af37] transition-colors" title="Simulates a sustain pedal for a reverberating effect">
                        <input type="checkbox" id="sustain-toggle" class="w-4 h-4 accent-[#6a1f1f] cursor-pointer">
                        <span>Extend Notes (Sustain)</span>
                    </label>
                </div>

                <!-- Piano Keys -->
                <div class="piano-container" id="piano">
                    <!-- Keys generated via JS -->
                </div>

                <div class="flex flex-col items-center justify-center w-full mt-6 gap-4">
                    <!-- Master Volume -->
                    <div class="flex items-center gap-3 bg-black/40 border border-[#3a2e2a] px-3 py-1.5 rounded-lg shadow-inner">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[#8c7355]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                        </svg>
                        <input type="range" id="master-volume" min="0" max="1" step="0.01" value="0.8" class="w-20 sm:w-24 accent-[#d4af37] cursor-pointer" title="Master Volume">
                    </div>

                    <button id="btn-edit-binds" class="gw2-button px-4 py-1.5 rounded font-bold text-sm tracking-widest text-center border border-[#5a4b3c] transition-all">
                        Edit Binds: OFF
                    </button>
                </div>

                <div class="mt-4 text-center status-text text-sm max-w-md" id="helper-text">
                    Use keys to play notes. Toggle <b class="text-[#d4af37]">Edit Binds</b> to change mapping. Click or touch keys to interact.
                </div>
            </div>

            <!-- ============================== -->
            <!-- VIEW 2: HEARTOPIA (3 Octaves)  -->
            <!-- ============================== -->
            <div id="htp-view" class="hidden flex-col items-center w-full max-w-5xl px-4 py-8 rounded-2xl border-2 border-[#5a4b3c] shadow-inner overflow-x-auto">
                <div id="heartopia-container" class="flex flex-col gap-8 min-w-[700px] py-4 px-8">
                    <!-- 3 Tiers Generated via JS -->
                </div>
                <div class="mt-4 text-center status-text text-sm max-w-md">
                    Binds perfectly map to standard QWERTY rows to replicate the Heartopia layout exactly.
                </div>
            </div>

            <!-- Global View Controls -->
            <div class="flex flex-col justify-center items-center w-full mt-8 gap-4 px-4">
                <button id="btn-toggle-view" class="gw2-button px-4 py-1.5 rounded font-bold text-sm tracking-widest text-center shadow-lg border border-[#d4af37] text-[#d4af37]">
                    Switch to Heartopia View
                </button>
            </div>

        </div> <!-- End Main App Panel -->

        <!-- Songbook Panel -->
        <div id="songbook-panel" class="gw2-panel hidden flex-col w-full xl:w-[500px] 2xl:w-[600px] rounded-xl p-4">
            <h2 class="gw2-title text-2xl mb-4 text-center">Tome Viewer</h2>

            <!-- Quick Load Tomes -->
            <div class="flex flex-wrap justify-center gap-3 mb-5">
                <button id="btn-load-tome-light" class="gw2-button px-3 py-1.5 rounded font-bold text-xs tracking-widest border border-[#5a4b3c] flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    Tome of Melodies (Light)
                </button>
                <button id="btn-load-tome-dark" class="gw2-button px-3 py-1.5 rounded font-bold text-xs tracking-widest border border-[#d4af37] flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    Tome of Melodies (Dark)
                </button>
            </div>

            <div class="flex justify-center gap-2 mb-2 w-full max-w-md mx-auto">
                <input type="text" id="songbook-url" class="gw2-select flex-1 px-3 py-1.5 rounded text-sm outline-none placeholder-[#8c7355]" placeholder="Paste Google Doc link here..." value="https://docs.google.com/document/d/1gX4ohvjG1Jr3nzWyC-mwYswzj8EsgLt9cHSNSCrTl7c/preview">
                <button id="btn-load-songbook" class="gw2-button px-4 py-1.5 rounded font-bold text-sm tracking-widest">Load</button>
            </div>

            <div class="mb-4 text-center status-text text-sm max-w-md mx-auto">
                Paste a <b class="text-[#d4af37]">Google Doc</b> link in the field above to view it here.
            </div>

            <iframe id="songbook-frame" class="w-full flex-1 bg-[#e6d8c3] rounded border border-[#5a4b3c] min-h-[500px] xl:min-h-0" src="https://docs.google.com/document/d/1gX4ohvjG1Jr3nzWyC-mwYswzj8EsgLt9cHSNSCrTl7c/preview" title="Songbook"></iframe>
        </div>

    </div> <!-- End Flex Wrapper -->

    <script>
        // --- Configuration & State ---
        let currentViewMode = 'gw2'; // 'gw2' or 'heartopia'
        let currentOctave = 4; // Mid
        let octaveMode = 'restricted'; // 'restricted' or 'full'
        let audioCtx;
        let masterGainNode;
        let activeNodes = {}; // Tracks active oscillators globally by element ID
        let isSustainEnabled = false;

        // --- View Toggling ---
        const btnToggleView = document.getElementById('btn-toggle-view');
        const gw2View = document.getElementById('gw2-view');
        const htpView = document.getElementById('htp-view');

        const btnToggleSongbook = document.getElementById('btn-toggle-songbook');
        const songbookPanel = document.getElementById('songbook-panel');
        const songbookUrlInput = document.getElementById('songbook-url');
        const btnLoadSongbook = document.getElementById('btn-load-songbook');
        const songbookFrame = document.getElementById('songbook-frame');

        const btnLoadTomeLight = document.getElementById('btn-load-tome-light');
        const btnLoadTomeDark = document.getElementById('btn-load-tome-dark');

        let isSongbookOpen = false;

        btnToggleSongbook.addEventListener('click', () => {
            isSongbookOpen = !isSongbookOpen;
            if (isSongbookOpen) {
                songbookPanel.classList.remove('hidden');
                songbookPanel.classList.add('flex');
                btnToggleSongbook.textContent = "Close Songbook";
                if (!songbookFrame.src) {
                    loadSongbookUrl();
                }
            } else {
                songbookPanel.classList.add('hidden');
                songbookPanel.classList.remove('flex');
                btnToggleSongbook.textContent = "Open Songbook";
            }
        });

        function loadSongbookUrl() {
            let url = songbookUrlInput.value.trim();
            if (!url) return;
            // Convert /edit to /preview for better iframe presentation without toolbars
            if (url.includes('docs.google.com') && url.includes('/edit')) {
                url = url.replace(/\/edit.*$/, '/preview');
            }
            songbookFrame.src = url;
            showMessage("Loading Tome...");
        }

        btnLoadSongbook.addEventListener('click', loadSongbookUrl);
        songbookUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadSongbookUrl();
        });

        function setActiveTomeButton(activeBtn, inactiveBtn) {
            activeBtn.classList.add('border-[#d4af37]');
            activeBtn.classList.remove('border-[#5a4b3c]');
            inactiveBtn.classList.add('border-[#5a4b3c]');
            inactiveBtn.classList.remove('border-[#d4af37]');
        }

        btnLoadTomeLight.addEventListener('click', () => {
            songbookUrlInput.value = 'https://docs.google.com/document/d/1KOYLOCvwig71yQjDXOGW9mUHWy9aoW8ziRLUBjxX_nA/preview';
            setActiveTomeButton(btnLoadTomeLight, btnLoadTomeDark);
            loadSongbookUrl();
        });

        btnLoadTomeDark.addEventListener('click', () => {
            songbookUrlInput.value = 'https://docs.google.com/document/d/1gX4ohvjG1Jr3nzWyC-mwYswzj8EsgLt9cHSNSCrTl7c/preview';
            setActiveTomeButton(btnLoadTomeDark, btnLoadTomeLight);
            loadSongbookUrl();
        });

        btnToggleView.addEventListener('click', () => {
            if (currentViewMode === 'gw2') {
                currentViewMode = 'heartopia';
                gw2View.classList.add('hidden');
                htpView.classList.remove('hidden');
                htpView.classList.add('flex');
                btnToggleView.textContent = "Switch to Guild Wars 2 View";
                showMessage("Heartopia Resonance engaged.");
            } else {
                currentViewMode = 'gw2';
                htpView.classList.add('hidden');
                htpView.classList.remove('flex');
                gw2View.classList.remove('hidden');
                btnToggleView.textContent = "Switch to Heartopia View";
                showMessage("Tyrian Resonance engaged.");
            }
        });

        // --- GW2 Mode Data ---
        const notes = [
            { name: 'C', offset: 0, isBlack: false },
            { name: 'C#', offset: 1, isBlack: true },
            { name: 'D', offset: 2, isBlack: false },
            { name: 'D#', offset: 3, isBlack: true },
            { name: 'E', offset: 4, isBlack: false },
            { name: 'F', offset: 5, isBlack: false },
            { name: 'F#', offset: 6, isBlack: true },
            { name: 'G', offset: 7, isBlack: false },
            { name: 'G#', offset: 8, isBlack: true },
            { name: 'A', offset: 9, isBlack: false },
            { name: 'A#', offset: 10, isBlack: true },
            { name: 'B', offset: 11, isBlack: false },
            { name: 'C', offset: 12, isBlack: false }
        ];

        let bindings = {
            notes: ['Digit1', 'F1', 'Digit2', 'F2', 'Digit3', 'Digit4', 'F4', 'Digit5', 'F5', 'Digit6', 'F6', 'Digit7', 'Digit8'],
            octaveDown: 'KeyQ',
            octaveUp: 'KeyE'
        };

        // Load custom binds from local storage
        try {
            const savedBinds = localStorage.getItem('tyrianPianoBinds');
            if (savedBinds) {
                bindings = JSON.parse(savedBinds);
            }
        } catch (e) {
            console.warn("Could not load bindings", e);
        }

        // Helper to save binds
        function saveBinds() {
            try {
                localStorage.setItem('tyrianPianoBinds', JSON.stringify(bindings));
            } catch (e) {
                console.warn("Could not save bindings", e);
            }
        }

        let activeRebind = null;
        let isRemappingMode = false;

        function formatKey(code) {
            if (code.startsWith('Key')) return code.slice(3);
            if (code.startsWith('Digit')) return code.slice(5);
            if (code.startsWith('Numpad')) return 'Num ' + code.slice(6);
            if (code === 'Space') return 'Spc';
            if (code === 'Minus') return '-';
            if (code === 'Equal') return '=';
            if (code === 'Comma') return ',';
            if (code === 'Period') return '.';
            if (code === 'Slash') return '/';
            if (code === 'Semicolon') return ';';
            if (code === 'BracketLeft') return '[';
            if (code === 'BracketRight') return ']';
            return code;
        }

        function getFormattedBindString(code, octave) {
            let keyStr = code === '?' ? '?' : formatKey(code);
            if (octave < 4) return `[ ${keyStr} ]`;
            if (octave > 4) return `( ${keyStr} )`;
            return keyStr;
        }

        function startRebind(e, type, index, targetEl) {
            e.stopPropagation();
            e.preventDefault();

            if (activeRebind) cancelRebind();

            let originalText = targetEl.innerHTML;
            let placeholder = type === 'note' ? getFormattedBindString('?', currentOctave) : '[ ? ]';
            targetEl.innerHTML = `<span class="text-[#ff8c00] animate-pulse">${placeholder}</span>`;

            activeRebind = { type, index, el: targetEl, originalText };
            showMessage("Press any key to bind...");
        }

        function cancelRebind() {
            if (!activeRebind) return;
            activeRebind.el.innerHTML = activeRebind.originalText;
            activeRebind = null;
        }

        // --- Heartopia Mode Data ---
        const htpLayout = [
            // TOP TIER (High, Octave 5)
            { octave: 5, dot: 'top', keys: [
                { offset: 0, solfege: 'DO', bindLabel: 'Q', code: 'KeyQ', num: 1, type: 'white' },
                { offset: 1, bindLabel: '2', code: 'Digit2', type: 'black' },
                { offset: 2, solfege: 'RE', bindLabel: 'W', code: 'KeyW', num: 2, type: 'white' },
                { offset: 3, bindLabel: '3', code: 'Digit3', type: 'black' },
                { offset: 4, solfege: 'MI', bindLabel: 'E', code: 'KeyE', num: 3, type: 'white' },
                { offset: 5, solfege: 'FA', bindLabel: 'R', code: 'KeyR', num: 4, type: 'white', gap: true },
                { offset: 6, bindLabel: '5', code: 'Digit5', type: 'black' },
                { offset: 7, solfege: 'SOL', bindLabel: 'T', code: 'KeyT', num: 5, type: 'white' },
                { offset: 8, bindLabel: '6', code: 'Digit6', type: 'black' },
                { offset: 9, solfege: 'LA', bindLabel: 'Y', code: 'KeyY', num: 6, type: 'white' },
                { offset: 10, bindLabel: '7', code: 'Digit7', type: 'black' },
                { offset: 11, solfege: 'SI', bindLabel: 'U', code: 'KeyU', num: 7, type: 'white' },
                { offset: 12, solfege: 'DO', bindLabel: 'I', code: 'KeyI', num: 1, type: 'white' }
            ]},
            // MIDDLE TIER (Mid, Octave 4)
            { octave: 4, dot: 'none', keys: [
                { offset: 0, solfege: 'DO', bindLabel: 'Z', code: 'KeyZ', num: 1, type: 'white' },
                { offset: 1, bindLabel: 'S', code: 'KeyS', type: 'black' },
                { offset: 2, solfege: 'RE', bindLabel: 'X', code: 'KeyX', num: 2, type: 'white' },
                { offset: 3, bindLabel: 'D', code: 'KeyD', type: 'black' },
                { offset: 4, solfege: 'MI', bindLabel: 'C', code: 'KeyC', num: 3, type: 'white' },
                { offset: 5, solfege: 'FA', bindLabel: 'V', code: 'KeyV', num: 4, type: 'white', gap: true },
                { offset: 6, bindLabel: 'G', code: 'KeyG', type: 'black' },
                { offset: 7, solfege: 'SOL', bindLabel: 'B', code: 'KeyB', num: 5, type: 'white' },
                { offset: 8, bindLabel: 'H', code: 'KeyH', type: 'black' },
                { offset: 9, solfege: 'LA', bindLabel: 'N', code: 'KeyN', num: 6, type: 'white' },
                { offset: 10, bindLabel: 'J', code: 'KeyJ', type: 'black' },
                { offset: 11, solfege: 'SI', bindLabel: 'M', code: 'KeyM', num: 7, type: 'white' }
            ]},
            // BOTTOM TIER (Low, Octave 3)
            { octave: 3, dot: 'bottom', keys: [
                { offset: 0, solfege: 'DO', bindLabel: 'Q', code: 'Comma', num: 1, type: 'white', overrideLabel: ',' },
                { offset: 1, bindLabel: 'L', code: 'KeyL', type: 'black' },
                { offset: 2, solfege: 'RE', bindLabel: '.', code: 'Period', num: 2, type: 'white' },
                { offset: 3, bindLabel: ';', code: 'Semicolon', type: 'black' },
                { offset: 4, solfege: 'MI', bindLabel: '/', code: 'Slash', num: 3, type: 'white' },
                { offset: 5, solfege: 'FA', bindLabel: 'O', code: 'KeyO', num: 4, type: 'white', gap: true },
                { offset: 6, bindLabel: '0', code: 'Digit0', type: 'black' },
                { offset: 7, solfege: 'SOL', bindLabel: 'P', code: 'KeyP', num: 5, type: 'white' },
                { offset: 8, bindLabel: '-', code: 'Minus', type: 'black' },
                { offset: 9, solfege: 'LA', bindLabel: '[', code: 'BracketLeft', num: 6, type: 'white' },
                { offset: 10, bindLabel: '=', code: 'Equal', type: 'black' },
                { offset: 11, solfege: 'SI', bindLabel: ']', code: 'BracketRight', num: 7, type: 'white' }
            ]}
        ];
        const heartopiaBindsMap = {};

        // Native Custom Soundfont Storage
        let sf2Data = { buffer: null, smplOffset: 0, smplSize: 0, presets: [], bufferCache: {} };

        function timecentsToSecs(tc) {
            if (tc <= -11950) return 0.001;
            return Math.pow(2, tc / 1200);
        }

        // --- DOM Elements ---
        const pianoContainer = document.getElementById('piano');
        const htpContainer = document.getElementById('heartopia-container');
        const octaveDisplay = document.getElementById('octave-display');
        const btnOctDown = document.getElementById('btn-oct-down');
        const btnOctUp = document.getElementById('btn-oct-up');
        const synthSelect = document.getElementById('synth-select');
        const octaveToggle = document.getElementById('octave-toggle');
        const sustainToggle = document.getElementById('sustain-toggle');
        const sf2Upload = document.getElementById('sf2-upload');
        const btnUnloadSf2 = document.getElementById('btn-unload-sf2');
        const sysMessage = document.getElementById('sys-message');
        const btnEditBinds = document.getElementById('btn-edit-binds');
        const helperText = document.getElementById('helper-text');

        // --- Build GW2 UI ---
        let currentWrapper = null;
        notes.forEach((note, index) => {
            const keyEl = document.createElement('div');
            const elementId = `gw2-key-${index}`;
            keyEl.id = elementId;
            keyEl.className = `piano-key ${note.isBlack ? 'black-key absolute top-0 z-10' : 'relative'}`;
            keyEl.dataset.index = index;

            keyEl.innerHTML = `
                <div class="key-note pointer-events-none">${note.name}</div>
                <div class="key-bind pointer-events-none transition-colors mt-1" data-index="${index}">${getFormattedBindString(bindings.notes[index], currentOctave)}</div>
            `;

            const handleInteract = (e) => {
                if (isRemappingMode) {
                    startRebind(e, 'note', index, keyEl.querySelector('.key-bind'));
                } else {
                    playNote(note.offset, currentOctave, elementId);
                }
            };

            keyEl.addEventListener('mousedown', handleInteract);
            keyEl.addEventListener('touchstart', (e) => { e.preventDefault(); handleInteract(e); });

            keyEl.addEventListener('mouseup', () => { if (!isRemappingMode) stopNote(elementId); });
            keyEl.addEventListener('mouseleave', () => { if (!isRemappingMode) stopNote(elementId); });
            keyEl.addEventListener('touchend', (e) => { e.preventDefault(); if (!isRemappingMode) stopNote(elementId); });
            keyEl.addEventListener('touchcancel', (e) => { e.preventDefault(); if (!isRemappingMode) stopNote(elementId); });

            if (!note.isBlack) {
                currentWrapper = document.createElement('div');
                currentWrapper.className = 'relative flex-none';
                currentWrapper.appendChild(keyEl);
                pianoContainer.appendChild(currentWrapper);
            } else if (currentWrapper) {
                currentWrapper.appendChild(keyEl);
            }
        });

        // --- Build Heartopia UI ---
        htpLayout.forEach(row => {
            const rowEl = document.createElement('div');
            rowEl.className = 'flex justify-center gap-2 relative';

            let lastWhiteWrapper = null;

            row.keys.forEach(key => {
                const elementId = `htp-key-${row.octave}-${key.offset}`;
                heartopiaBindsMap[key.code] = { octave: row.octave, offset: key.offset, elementId: elementId };

                if (key.type === 'white') {
                    const wrapper = document.createElement('div');
                    wrapper.className = `relative flex-none ${key.gap ? 'ml-8' : ''}`;

                    const dotHtml = row.dot === 'top' ? '<div class="absolute w-1.5 h-1.5 bg-[#444] rounded-full top-[5px]"></div>' :
                                    row.dot === 'bottom' ? '<div class="absolute w-1.5 h-1.5 bg-[#444] rounded-full bottom-[22px]"></div>' : '';

                    let tagLabel = key.overrideLabel || key.bindLabel;

                    wrapper.innerHTML = `
                        <div id="${elementId}" class="htp-white">
                            ${dotHtml}
                            <div class="htp-white-num ${row.dot === 'top' ? 'mt-1' : ''}">${key.num}</div>
                            <div class="htp-white-sol">${key.solfege}</div>
                            <div class="htp-bind-tag">${tagLabel}</div>
                        </div>
                    `;

                    const keyEl = wrapper.querySelector('.htp-white');
                    const handleInteract = (e) => { playNote(key.offset, row.octave, elementId); };

                    keyEl.addEventListener('mousedown', handleInteract);
                    keyEl.addEventListener('touchstart', (e) => { e.preventDefault(); handleInteract(e); });
                    keyEl.addEventListener('mouseup', () => { stopNote(elementId); });
                    keyEl.addEventListener('mouseleave', () => { stopNote(elementId); });
                    keyEl.addEventListener('touchend', (e) => { e.preventDefault(); stopNote(elementId); });
                    keyEl.addEventListener('touchcancel', (e) => { e.preventDefault(); stopNote(elementId); });

                    rowEl.appendChild(wrapper);
                    lastWhiteWrapper = wrapper;
                } else if (key.type === 'black') {
                    const blackHtml = `
                        <div id="${elementId}" class="htp-black">
                            ${key.bindLabel}
                        </div>
                    `;
                    if (lastWhiteWrapper) {
                        lastWhiteWrapper.insertAdjacentHTML('beforeend', blackHtml);
                        const keyEl = lastWhiteWrapper.querySelector('.htp-black');
                        const handleInteract = (e) => { playNote(key.offset, row.octave, elementId); };

                        keyEl.addEventListener('mousedown', handleInteract);
                        keyEl.addEventListener('touchstart', (e) => { e.preventDefault(); handleInteract(e); });
                        keyEl.addEventListener('mouseup', () => { stopNote(elementId); });
                        keyEl.addEventListener('mouseleave', () => { stopNote(elementId); });
                        keyEl.addEventListener('touchend', (e) => { e.preventDefault(); stopNote(elementId); });
                        keyEl.addEventListener('touchcancel', (e) => { e.preventDefault(); stopNote(elementId); });
                    }
                }
            });
            htpContainer.appendChild(rowEl);
        });

        // --- Core Audio Engine ---
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();

                masterGainNode = audioCtx.createGain();
                const volSlider = document.getElementById('master-volume');
                masterGainNode.gain.value = volSlider.value;
                masterGainNode.connect(audioCtx.destination);

                volSlider.addEventListener('input', (e) => {
                    if (masterGainNode) {
                        masterGainNode.gain.setValueAtTime(e.target.value, audioCtx.currentTime);
                    }
                });
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function loadSf2Buffer(sampleInfo) {
            initAudio();
            try {
                const numSamples = sampleInfo.end - sampleInfo.start;
                if (numSamples <= 0 || numSamples > 50000000) return null;

                let sr = sampleInfo.sampleRate || 44100;
                if (sr < 8000) sr = 8000;
                if (sr > 96000) sr = 96000;

                const buffer = audioCtx.createBuffer(1, numSamples, sr);
                const channelData = buffer.getChannelData(0);
                const dv = new DataView(sf2Data.buffer);

                let byteOffset = sf2Data.smplOffset + (sampleInfo.start * 2);

                for (let i = 0; i < numSamples; i++) {
                    channelData[i] = dv.getInt16(byteOffset, true) / 32768.0;
                    byteOffset += 2;
                }
                return buffer;
            } catch(e) {
                return null;
            }
        }

        function playNote(offset, octave, elementId) {
            initAudio();
            if (activeNodes[elementId]) return;

            const midiNote = 12 * (octave + 1) + offset;
            const freq = 440 * Math.pow(2, (midiNote - 69) / 12);
            const instrumentMode = synthSelect.value;

            if (instrumentMode.startsWith('sf2_')) {
                // SF2 Synth
                const sfIndex = parseInt(instrumentMode.split('_')[1]);
                const preset = sf2Data.presets[sfIndex];

                const velocity = 100;
                let matchedZones = preset.zones.filter(z =>
                    midiNote >= z.keyRange.low && midiNote <= z.keyRange.high &&
                    velocity >= z.velRange.low && velocity <= z.velRange.high
                );

                if (matchedZones.length === 0) matchedZones = preset.zones.filter(z => midiNote >= z.keyRange.low && midiNote <= z.keyRange.high);
                if (matchedZones.length === 0 && preset.zones.length > 0) matchedZones = [preset.zones[0]];

                const sources = [];
                const gainNodes = [];

                matchedZones.forEach(zone => {
                    let cacheKey = zone.sample.name + "_" + zone.sample.start;
                    if (!sf2Data.bufferCache[cacheKey]) {
                        sf2Data.bufferCache[cacheKey] = loadSf2Buffer(zone.sample);
                    }

                    const buffer = sf2Data.bufferCache[cacheKey];
                    if (buffer) {
                        const gainNode = audioCtx.createGain();

                        let rootPitch = zone.rootKey !== undefined ? zone.rootKey : zone.sample.originalPitch;
                        if (rootPitch === 255 || rootPitch === 0) rootPitch = 60;

                        let centsOffset = zone.tuneCents + (zone.sample.pitchCorrection || 0);
                        const playbackRate = Math.pow(2, (midiNote - rootPitch + (centsOffset / 100)) / 12);

                        const source = audioCtx.createBufferSource();
                        source.buffer = buffer;
                        source.playbackRate.value = playbackRate;

                        if ((zone.sampleModes & 1) === 1 || (zone.sampleModes & 3) === 3) {
                            source.loop = true;
                            source.loopStart = Math.max(0, (zone.sample.startLoop - zone.sample.start) / zone.sample.sampleRate);
                            source.loopEnd = Math.max(0, (zone.sample.endLoop - zone.sample.start) / zone.sample.sampleRate);
                        }

                        let dly = timecentsToSecs(zone.volEnv.delay);
                        let atk = timecentsToSecs(zone.volEnv.attack);
                        let hld = timecentsToSecs(zone.volEnv.hold);
                        let dec = timecentsToSecs(zone.volEnv.decay);

                        let susGain = 1.0;
                        if (zone.volEnv.sustain > 0) {
                            let attenuationDB = zone.volEnv.sustain / 10;
                            susGain = Math.max(0.001, Math.pow(10, -attenuationDB / 20));
                        }

                        let baseGain = 1.0 / Math.max(1, matchedZones.length);
                        let now = audioCtx.currentTime;

                        gainNode.gain.setValueAtTime(0, now);
                        if (dly > 0.002) gainNode.gain.setValueAtTime(0, now + dly);
                        gainNode.gain.linearRampToValueAtTime(baseGain, now + dly + atk);
                        if (hld > 0.002) gainNode.gain.setValueAtTime(baseGain, now + dly + atk + hld);
                        gainNode.gain.exponentialRampToValueAtTime(Math.max(0.001, baseGain * susGain), now + dly + atk + hld + dec);

                        source.connect(gainNode);
                        gainNode.connect(masterGainNode);
                        source.start(now + dly);

                        sources.push(source);
                        gainNodes.push(gainNode);
                    }
                });

                if (sources.length > 0) {
                    activeNodes[elementId] = { sources, gainNodes, zones: matchedZones, mode: 'sf2' };
                }

            } else {
                // Procedural Synth
                const gainNode = audioCtx.createGain();
                const osc1 = audioCtx.createOscillator();
                const osc2 = audioCtx.createOscillator();
                const filterNode = audioCtx.createBiquadFilter();

                if (instrumentMode === 'lute') {
                    osc1.type = 'sawtooth'; osc2.type = 'triangle';
                    osc1.frequency.value = freq; osc2.frequency.value = freq * 1.002;
                    filterNode.type = 'lowpass';
                    filterNode.frequency.setValueAtTime(4000, audioCtx.currentTime);
                    filterNode.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.5);
                    gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.8, audioCtx.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.1, audioCtx.currentTime + 1.2);
                } else if (instrumentMode === 'brass') {
                    osc1.type = 'square'; osc2.type = 'sine';
                    osc1.frequency.value = freq; osc2.frequency.value = freq * 0.998;
                    filterNode.type = 'lowpass';
                    filterNode.frequency.setValueAtTime(1000, audioCtx.currentTime);
                    filterNode.frequency.linearRampToValueAtTime(2500, audioCtx.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.6, audioCtx.currentTime + 0.1);
                    gainNode.gain.setTargetAtTime(0.4, audioCtx.currentTime + 0.1, 0.3);
                } else if (instrumentMode === 'flute') {
                    osc1.type = 'sine'; osc2.type = 'sine';
                    osc1.frequency.value = freq; osc2.frequency.value = freq * 1.005;
                    filterNode.type = 'lowpass'; filterNode.frequency.setValueAtTime(2000, audioCtx.currentTime);
                    gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.15);
                    gainNode.gain.setTargetAtTime(0.4, audioCtx.currentTime + 0.15, 0.2);
                } else if (instrumentMode === 'crystal') {
                    osc1.type = 'triangle'; osc2.type = 'sine';
                    osc1.frequency.value = freq; osc2.frequency.value = freq * 2;
                    filterNode.type = 'bandpass'; filterNode.frequency.setValueAtTime(freq * 2, audioCtx.currentTime);
                    filterNode.Q.value = 5;
                    gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.02);
                    gainNode.gain.exponentialRampToValueAtTime(0.05, audioCtx.currentTime + 2.0);
                }

                osc1.connect(filterNode); osc2.connect(filterNode);
                filterNode.connect(gainNode); gainNode.connect(masterGainNode);
                osc1.start(); osc2.start();

                activeNodes[elementId] = { osc1, osc2, gainNode, mode: instrumentMode };
            }

            // Visuals
            const keyEl = document.getElementById(elementId);
            if (keyEl) keyEl.classList.add('active');
        }

        function stopNote(elementId) {
            if (!activeNodes[elementId]) return;

            const node = activeNodes[elementId];
            const mode = node.mode;

            if (mode === 'sf2') {
                const { sources, gainNodes, zones } = node;
                let now = audioCtx.currentTime;

                for (let i = 0; i < sources.length; i++) {
                    let gainNode = gainNodes[i];
                    let source = sources[i];
                    let zone = zones[i];

                    let rel = timecentsToSecs(zone.volEnv.release);
                    rel = Math.max(rel, isSustainEnabled ? 5.0 : 1.5);

                    gainNode.gain.cancelScheduledValues(now);
                    gainNode.gain.setValueAtTime(gainNode.gain.value, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + rel);
                    source.stop(now + rel + 0.1);
                }
            } else {
                const { osc1, osc2, gainNode } = node;
                let baseRelease = (mode === 'crystal') ? 2.5 : (mode === 'brass' ? 1.5 : 1.5);
                let releaseTime = isSustainEnabled ? baseRelease * 3 : baseRelease;

                gainNode.gain.cancelScheduledValues(audioCtx.currentTime);
                gainNode.gain.setValueAtTime(gainNode.gain.value, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + releaseTime);
                osc1.stop(audioCtx.currentTime + releaseTime);
                osc2.stop(audioCtx.currentTime + releaseTime);
            }

            delete activeNodes[elementId];

            // Visuals
            const keyEl = document.getElementById(elementId);
            if (keyEl) keyEl.classList.remove('active');
        }

        // --- Controls ---
        function updateAllKeyLabels() {
            document.querySelectorAll('#gw2-view .key-bind').forEach(el => {
                let index = parseInt(el.dataset.index);
                if (!isNaN(index)) {
                    el.textContent = getFormattedBindString(bindings.notes[index], currentOctave);
                }
            });
        }

        function updateOctaveDisplay() {
            if (octaveMode === 'restricted') {
                if (currentOctave === 3) octaveDisplay.textContent = 'Octave: Low';
                else if (currentOctave === 4) octaveDisplay.textContent = 'Octave: Mid';
                else if (currentOctave === 5) octaveDisplay.textContent = 'Octave: High';
            } else {
                octaveDisplay.textContent = `Octave: ${currentOctave}`;
            }
            updateAllKeyLabels();
        }

        function updateOctave(delta) {
            currentOctave += delta;
            if (octaveMode === 'restricted') {
                if (currentOctave < 3) currentOctave = 3;
                if (currentOctave > 5) currentOctave = 5;
            } else {
                if (currentOctave < 1) currentOctave = 1;
                if (currentOctave > 7) currentOctave = 7;
            }
            updateOctaveDisplay();
        }

        const handleOctaveDown = (e) => {
            if (isRemappingMode) startRebind(e, 'octaveDown', null, btnOctDown);
            else {
                updateOctave(-1);
                btnOctDown.classList.add('active');
                setTimeout(() => btnOctDown.classList.remove('active'), 100);
            }
        };

        const handleOctaveUp = (e) => {
            if (isRemappingMode) startRebind(e, 'octaveUp', null, btnOctUp);
            else {
                updateOctave(1);
                btnOctUp.classList.add('active');
                setTimeout(() => btnOctUp.classList.remove('active'), 100);
            }
        };

        btnOctDown.addEventListener('mousedown', handleOctaveDown);
        btnOctUp.addEventListener('mousedown', handleOctaveUp);
        btnOctDown.addEventListener('touchstart', (e) => { e.preventDefault(); handleOctaveDown(e); });
        btnOctUp.addEventListener('touchstart', (e) => { e.preventDefault(); handleOctaveUp(e); });

        btnEditBinds.addEventListener('click', () => {
            isRemappingMode = !isRemappingMode;
            if (isRemappingMode) {
                btnEditBinds.textContent = 'Edit Binds: ON';
                btnEditBinds.classList.add('border-[#d4af37]', 'text-[#d4af37]');
                helperText.innerHTML = 'Click any <b class="text-[#d4af37]">Piano Key</b> or <b class="text-[#d4af37]">Octave Button</b> to remap it.';
            } else {
                btnEditBinds.textContent = 'Edit Binds: OFF';
                btnEditBinds.classList.remove('border-[#d4af37]', 'text-[#d4af37]');
                helperText.innerHTML = 'Use keys to play notes. Toggle <b class="text-[#d4af37]">Edit Binds</b> to change mapping. Click or touch keys to interact.';
                cancelRebind();
            }
        });

        octaveToggle.addEventListener('change', (e) => {
            octaveMode = e.target.checked ? 'restricted' : 'full';
            if (octaveMode === 'restricted') {
                if (currentOctave < 3) currentOctave = 3;
                if (currentOctave > 5) currentOctave = 5;
            }
            updateOctaveDisplay();
        });

        sustainToggle.addEventListener('change', (e) => {
            isSustainEnabled = e.target.checked;
            showMessage(isSustainEnabled ? "Sustain engaged: Notes will resonate." : "Sustain disengaged.");
        });

        // --- Keyboard Listener Routing ---
        window.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            if (/^F\d+$/.test(e.code)) e.preventDefault();

            // Route to GW2 Logic
            if (currentViewMode === 'gw2') {
                if (activeRebind) {
                    e.preventDefault(); e.stopPropagation();
                    const code = e.code;
                    if (code === 'Escape') { cancelRebind(); showMessage("Binding cancelled."); return; }

                    if (activeRebind.type === 'note') {
                        bindings.notes[activeRebind.index] = code;
                        activeRebind.el.innerHTML = getFormattedBindString(code, currentOctave);
                    }
                    else if (activeRebind.type === 'octaveDown') {
                        bindings.octaveDown = code;
                        activeRebind.el.innerHTML = `[ ${formatKey(code)} ] Octave -`;
                    }
                    else if (activeRebind.type === 'octaveUp') {
                        bindings.octaveUp = code;
                        activeRebind.el.innerHTML = `[ ${formatKey(code)} ] Octave +`;
                    }

                    saveBinds(); // Cache to local storage

                    showMessage(`Key bound to ${formatKey(code)}.`);
                    activeRebind = null; return;
                }

                if (e.code === bindings.octaveDown) {
                    updateOctave(-1);
                    btnOctDown.classList.add('active'); setTimeout(() => btnOctDown.classList.remove('active'), 100);
                } else if (e.code === bindings.octaveUp) {
                    updateOctave(1);
                    btnOctUp.classList.add('active'); setTimeout(() => btnOctUp.classList.remove('active'), 100);
                } else {
                    let noteIndex = bindings.notes.indexOf(e.code);
                    let fallbackIndex = -1;
                    const defaultDigitMap = {
                        'Numpad1': 0, 'Numpad2': 2, 'Numpad3': 4, 'Numpad4': 5,
                        'Numpad5': 7, 'Numpad6': 9, 'Numpad7': 11, 'Numpad8': 12
                    };
                    if (defaultDigitMap[e.code] !== undefined) {
                        let mappedIndex = defaultDigitMap[e.code];
                        let digitCode = 'Digit' + e.code.slice(6);
                        if (bindings.notes[mappedIndex] === digitCode) fallbackIndex = mappedIndex;
                    }

                    if (noteIndex !== -1) playNote(notes[noteIndex].offset, currentOctave, `gw2-key-${noteIndex}`);
                    else if (fallbackIndex !== -1) playNote(notes[fallbackIndex].offset, currentOctave, `gw2-key-${fallbackIndex}`);
                }
            }
            // Route to Heartopia Logic
            else if (currentViewMode === 'heartopia') {
                const htpBind = heartopiaBindsMap[e.code];
                if (htpBind) playNote(htpBind.offset, htpBind.octave, htpBind.elementId);
            }
        });

        window.addEventListener('keyup', (e) => {
            if (activeRebind) return;

            if (currentViewMode === 'gw2') {
                let noteIndex = bindings.notes.indexOf(e.code);
                let fallbackIndex = -1;
                const defaultDigitMap = {
                    'Numpad1': 0, 'Numpad2': 2, 'Numpad3': 4, 'Numpad4': 5,
                    'Numpad5': 7, 'Numpad6': 9, 'Numpad7': 11, 'Numpad8': 12
                };
                if (defaultDigitMap[e.code] !== undefined) {
                    let mappedIndex = defaultDigitMap[e.code];
                    let digitCode = 'Digit' + e.code.slice(6);
                    if (bindings.notes[mappedIndex] === digitCode) fallbackIndex = mappedIndex;
                }

                if (noteIndex !== -1) stopNote(`gw2-key-${noteIndex}`);
                else if (fallbackIndex !== -1) stopNote(`gw2-key-${fallbackIndex}`);
            }
            else if (currentViewMode === 'heartopia') {
                const htpBind = heartopiaBindsMap[e.code];
                if (htpBind) stopNote(htpBind.elementId);
            }
        });

        function showMessage(msg) {
            sysMessage.textContent = msg;
            sysMessage.style.opacity = 1;
            setTimeout(() => { sysMessage.style.opacity = 0; }, 3000);
        }

        synthSelect.addEventListener('change', (e) => {
            showMessage(`Instrument attuned to: ${e.target.options[e.target.selectedIndex].text}`);
        });

        // --- NATIVE SF2 PARSER ---
        btnUnloadSf2.addEventListener('click', () => {
            const optgroup = document.getElementById('sf2-optgroup');
            if (optgroup) optgroup.remove();

            synthSelect.value = 'lute';
            sf2Data = { buffer: null, smplOffset: 0, smplSize: 0, presets: [], bufferCache: {} };
            sf2Upload.value = '';

            btnUnloadSf2.classList.add('hidden');
            showMessage("Soundfont un-attuned. Memory cleared.");
        });

        sf2Upload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showMessage(`Attuning ${file.name}... parsing arcane structures.`);
            const reader = new FileReader();

            reader.onload = function(evt) {
                try {
                    const arrayBuffer = evt.target.result;
                    const dv = new DataView(arrayBuffer);
                    let offset = 0;

                    sf2Data = { buffer: arrayBuffer, smplOffset: 0, smplSize: 0, presets: [], bufferCache: {} };

                    function readStrAt(off, len) {
                        let s = '';
                        for(let i=0; i<len; i++) {
                            let c = dv.getUint8(off + i);
                            if (c === 0) break;
                            if (c >= 32 && c <= 126) s += String.fromCharCode(c);
                        }
                        return s.trim();
                    }

                    function readStr(len) {
                        let s = readStrAt(offset, len);
                        offset += len;
                        return s;
                    }

                    let pdtaChunks = {};

                    while (offset < arrayBuffer.byteLength - 8) {
                        let chunkId = readStr(4);
                        let chunkSize = dv.getUint32(offset, true); offset += 4;

                        if (chunkId === 'RIFF' || chunkId === 'LIST') {
                            readStr(4);
                            continue;
                        }

                        let nextOffset = offset + chunkSize;
                        if (chunkSize % 2 !== 0) nextOffset++;

                        if (chunkId === 'smpl') {
                            sf2Data.smplOffset = offset;
                            sf2Data.smplSize = chunkSize;
                        } else if (['phdr', 'pbag', 'pgen', 'inst', 'ibag', 'igen', 'shdr'].includes(chunkId)) {
                            pdtaChunks[chunkId] = { offset, size: chunkSize };
                        }
                        offset = nextOffset;
                    }

                    if (pdtaChunks.phdr && pdtaChunks.shdr && sf2Data.smplSize > 0) {
                        let shdr = [], igen = [], ibag = [], inst = [], pgen = [], pbag = [], phdr = [];

                        let o = pdtaChunks.shdr.offset, end = o + pdtaChunks.shdr.size;
                        while(o < end) {
                            shdr.push({
                                name: readStrAt(o, 20), start: dv.getUint32(o+20, true), end: dv.getUint32(o+24, true),
                                startLoop: dv.getUint32(o+28, true), endLoop: dv.getUint32(o+32, true),
                                sampleRate: dv.getUint32(o+36, true), originalPitch: dv.getUint8(o+40),
                                pitchCorrection: dv.getInt8(o+41), sampleType: dv.getUint16(o+44, true)
                            }); o += 46;
                        }

                        o = pdtaChunks.igen.offset; end = o + pdtaChunks.igen.size;
                        while(o < end) { igen.push({ oper: dv.getUint16(o, true), amount: dv.getUint16(o+2, true), amountInt: dv.getInt16(o+2, true) }); o += 4; }

                        o = pdtaChunks.ibag.offset; end = o + pdtaChunks.ibag.size;
                        while(o < end) { ibag.push({ genNdx: dv.getUint16(o, true) }); o += 4; }

                        o = pdtaChunks.inst.offset; end = o + pdtaChunks.inst.size;
                        while(o < end) { inst.push({ name: readStrAt(o, 20), ibagNdx: dv.getUint16(o+20, true) }); o += 22; }

                        o = pdtaChunks.pgen.offset; end = o + pdtaChunks.pgen.size;
                        while(o < end) { pgen.push({ oper: dv.getUint16(o, true), amount: dv.getUint16(o+2, true) }); o += 4; }

                        o = pdtaChunks.pbag.offset; end = o + pdtaChunks.pbag.size;
                        while(o < end) { pbag.push({ genNdx: dv.getUint16(o, true) }); o += 4; }

                        o = pdtaChunks.phdr.offset; end = o + pdtaChunks.phdr.size;
                        while(o < end) {
                            phdr.push({ name: readStrAt(o, 20), preset: dv.getUint16(o+20, true), bank: dv.getUint16(o+22, true), pbagNdx: dv.getUint16(o+24, true) });
                            o += 38;
                        }

                        for (let i = 0; i < phdr.length - 1; i++) {
                            let preset = phdr[i];
                            if (preset.name === 'EOP') continue;
                            let presetZones = [];

                            for (let j = preset.pbagNdx; j < phdr[i+1].pbagNdx; j++) {
                                let pGenEnd = pbag[j+1] ? pbag[j+1].genNdx : pgen.length;
                                let instId = -1;
                                for (let k = pbag[j].genNdx; k < pGenEnd; k++) if (pgen[k].oper === 41) instId = pgen[k].amount;

                                if (instId >= 0 && instId < inst.length - 1) {
                                    let globalInstZone = {
                                        tuneCents: 0, velRange: { low: 0, high: 127 }, sampleModes: 0,
                                        volEnv: { delay: -12000, attack: -12000, hold: -12000, decay: -12000, sustain: 0, release: -12000 }
                                    };

                                    for (let z = inst[instId].ibagNdx; z < inst[instId+1].ibagNdx; z++) {
                                        let iGenEnd = ibag[z+1] ? ibag[z+1].genNdx : igen.length;

                                        let zoneData = {
                                            keyRange: { low: 0, high: 127 }, velRange: { ...globalInstZone.velRange },
                                            tuneCents: globalInstZone.tuneCents, sampleModes: globalInstZone.sampleModes,
                                            volEnv: { ...globalInstZone.volEnv }
                                        };
                                        let sampleId = -1;

                                        for (let g = ibag[z].genNdx; g < iGenEnd; g++) {
                                            let gen = igen[g];
                                            if (gen.oper === 43) zoneData.keyRange = { low: gen.amount & 0xFF, high: gen.amount >> 8 };
                                            else if (gen.oper === 44) zoneData.velRange = { low: gen.amount & 0xFF, high: gen.amount >> 8 };
                                            else if (gen.oper === 53) sampleId = gen.amount;
                                            else if (gen.oper === 58) zoneData.rootKey = gen.amount & 0xFF;
                                            else if (gen.oper === 51) zoneData.tuneCents += gen.amountInt * 100;
                                            else if (gen.oper === 52) zoneData.tuneCents += gen.amountInt;
                                            else if (gen.oper === 54) zoneData.sampleModes = gen.amount;
                                            else if (gen.oper === 33) zoneData.volEnv.delay = gen.amountInt;
                                            else if (gen.oper === 34) zoneData.volEnv.attack = gen.amountInt;
                                            else if (gen.oper === 35) zoneData.volEnv.hold = gen.amountInt;
                                            else if (gen.oper === 36) zoneData.volEnv.decay = gen.amountInt;
                                            else if (gen.oper === 37) zoneData.volEnv.sustain = gen.amountInt;
                                            else if (gen.oper === 38) zoneData.volEnv.release = gen.amountInt;
                                        }

                                        if (sampleId === -1 && z === inst[instId].ibagNdx) {
                                            globalInstZone = zoneData;
                                        } else if (sampleId >= 0 && sampleId < shdr.length) {
                                            zoneData.sample = shdr[sampleId];
                                            presetZones.push(zoneData);
                                        }
                                    }
                                }
                            }
                            if (presetZones.length > 0) sf2Data.presets.push({ name: preset.name, bank: preset.bank, presetId: preset.preset, zones: presetZones });
                        }
                    }

                    if (sf2Data.presets.length > 0) {
                        let optgroup = document.getElementById('sf2-optgroup');
                        if (!optgroup) {
                            optgroup = document.createElement('optgroup');
                            optgroup.id = 'sf2-optgroup';
                            optgroup.label = `SF2: ${file.name}`;
                            synthSelect.appendChild(optgroup);
                        }
                        optgroup.innerHTML = '';

                        sf2Data.presets.forEach((preset, index) => {
                            let opt = document.createElement('option');
                            opt.value = 'sf2_' + index;
                            let bnk = preset.bank === 128 ? 'Perc' : preset.bank;
                            opt.textContent = `[Bank ${bnk}] ${preset.name}`;
                            optgroup.appendChild(opt);
                        });

                        synthSelect.value = 'sf2_0';
                        btnUnloadSf2.classList.remove('hidden');
                        showMessage(`Success! Reconstructed ${sf2Data.presets.length} Presets.`);
                    } else {
                        showMessage(`Could not read valid instrument presets.`);
                    }

                } catch (e) {
                    showMessage(`Error parsing Soundfont file.`);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        updateOctaveDisplay();

    </script>
</body>
</html>
